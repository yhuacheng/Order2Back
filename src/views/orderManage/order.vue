<template>
	<section>
		<!--工具条-->
		<el-col :span="24" class="toolbar" style="padding-bottom: 0px;">
			<el-form :inline="true" :model="searchForm" size="small">
				<el-form-item label="搜索内容">
					<el-input @keyup.native="searchToTrim" @keyup.enter.native="searchData"
						v-model="searchForm.searchWords" placeholder="订单号/产品名称/ASIN/客户编码" style="width: 220px;">
					</el-input>
				</el-form-item>
				<el-form-item label="订单类型">
					<el-select v-model="searchForm.serveType" placeholder="请选择" style="width: 150px;">
						<el-option value="0" label="全部"></el-option>
						<el-option value="1" label="评后返（代返）"></el-option>
						<el-option value="2" label="评后返（自返）"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="国家">
					<el-select v-model="searchForm.country" placeholder="请选择国家" style="width: 100px;">
						<el-option value="0" label="全部"></el-option>
						<el-option v-for="item in countryData" :key="item.Id" :label="item.CountryName"
							:value="item.Id"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="是否超时">
					<el-select v-model="searchForm.type" placeholder="请选择" style="width: 100px;">
						<el-option value="0" label="全部"></el-option>
						<el-option value="1" label="正常"></el-option>
						<el-option value="-1" label="超时"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="内单外单">
					<el-select v-model="searchForm.types" placeholder="请选择" style="width: 100px;">
						<el-option value="0" label="全部"></el-option>
						<el-option value="1" label="内单"></el-option>
						<el-option value="2" label="外单"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="下单时间">
					<el-date-picker v-model="searchForm.time" :unlink-panels='true' type="datetimerange"
						range-separator="至" start-placeholder="开始时间" end-placeholder="结束时间"
						value-format="yyyy-MM-dd HH:mm:ss"></el-date-picker>
				</el-form-item>
				<el-form-item>
					<el-button type="primary" @click="searchData(0)">查询</el-button>
					<el-button @click="resetSearch">重置</el-button>
				</el-form-item>
			</el-form>
		</el-col>

		<!--工具条-->
		<el-col :span="24" class="toolbar">
			<el-button v-if="menuBtnShow" type="primary" size="mini" :disabled="disabledEditFee" @click="editModalShow">
				修改【客户】服务费和汇率</el-button>
			<el-button v-if="menuBtnShow && searchForm.state==1" type="success" size="mini" @click="orderConfirmMore(1)"
				:disabled="disabledMore" :loading="btnLoading">批量确认</el-button>
			<el-button v-if="menuBtnShow && searchForm.state==1" type="danger" size="mini" @click="orderConfirmMore(2)"
				:disabled="disabledMore" :loading="btnLoading">批量取消</el-button>
			<el-button v-if="menuBtnShow && searchForm.state==2" type="danger" size="mini" @click="timeModalShow(1)"
				:disabled="disabledMore">批量分配任务</el-button>
			<el-button type="warning" size="mini" @click="exportExcel">导出</el-button>
			<div class="tagMenu">
				<el-badge :value="all" type="success" class="item">
					<el-button size="mini" @click='searchStateData(0)' :class="{'active':searchForm.state==0}">全部
					</el-button>
				</el-badge>
				<el-badge :value="dqr" type="info" class="item">
					<el-button size="mini" @click='searchStateData(1)' :class="{'active':searchForm.state==1}">待确认
					</el-button>
				</el-badge>
				<el-badge :value="dfp" type="primary" class="item">
					<el-button size="mini" @click='searchStateData(2)' :class="{'active':searchForm.state==2}">待分配
					</el-button>
				</el-badge>
				<el-badge :value="yfp" type="warning" class="item">
					<el-button size="mini" @click='searchStateData(3)' :class="{'active':searchForm.state==3}">已分配
					</el-button>
				</el-badge>
				<el-badge :value="ywc" type="success" class="item">
					<el-button size="mini" @click='searchStateData(4)' :class="{'active':searchForm.state==4}">已完成
					</el-button>
				</el-badge>
				<el-badge :value="yqx" type="danger">
					<el-button size="mini" @click='searchStateData(5)' :class="{'active':searchForm.state==5}">已取消
					</el-button>
				</el-badge>
			</div>
		</el-col>
		<!--列表-->
		<pl-table border :data="tableData" v-loading="listLoading" id="exportTable" style="width: 100%"
			:header-cell-style="{background:'#fafafa'}" @selection-change="handleSelectionChange" @row-click="rowClick"
			ref="table" use-virtual max-height="850" :row-height="80">
			<pl-table-column type="selection" align="center"></pl-table-column>
			<pl-table-column type="index" label="序号" align="center" width="50"></pl-table-column>
			<pl-table-column fixed="left" prop="OrderNumber" label="订单编号" align="center" width="140">
				<template slot-scope="scope">
					<i class="el-icon-document-copy" @click.stop="copy(scope.$index,scope.row)"></i>
					<el-link type="primary" :underline="false" @click.stop="viewModalShow(scope.$index,scope.row)">
						{{scope.row.OrderNumber}}
					</el-link>
					<div>
						<span v-if="scope.row.Overtime<0"><span class="danger fz12">超时</span></span>
					</div>
				</template>
			</pl-table-column>
			<pl-table-column prop="OrderProductPictures" label="产品图" align="center" width="70px">
				<template slot-scope="scope">
					<el-image style="width: 40px;height: 40px;" v-if="scope.row.ProductPictures"
						:src="$IMG_URL+scope.row.ProductPictures" @click.stop="showImage(scope.$index,scope.row)">
					</el-image>
				</template>
			</pl-table-column>
			<pl-table-column prop="ServiceType" label="订单类型" align="center" width="105">
				<template slot-scope="scope">
					<span v-if="scope.row.ServiceType==1">评后返(代返)</span>
					<span v-if="scope.row.ServiceType==2">评后返(自返)</span>
				</template>
			</pl-table-column>
			<pl-table-column prop="CountryName" label="国家" align="center"></pl-table-column>
			<pl-table-column prop="ASIN" label="ASIN" align="center" width="120"></pl-table-column>
			<pl-table-column prop="ProductName" label="产品名称" align="center" :show-overflow-tooltip='true'>
			</pl-table-column>
			<pl-table-column prop="ShopName" label="店铺" align="center" :show-overflow-tooltip='true'></pl-table-column>
			<pl-table-column prop="ProductKeyWord" label="关键词" align="center" :show-overflow-tooltip='true'>
			</pl-table-column>
			<pl-table-column prop="Brand" label="品牌" align="center" :show-overflow-tooltip='true'></pl-table-column>
			<pl-table-column prop="Place" label="产品位置" align="center" :show-overflow-tooltip='true'></pl-table-column>
			<pl-table-column prop="Number" label="任务数" align="center"></pl-table-column>
			<pl-table-column prop="noBuy" label="待购买数" align="center">
				<template slot-scope="scope">
					<span class="danger">{{scope.row.noBuy}}</span>
				</template>
			</pl-table-column>
			<pl-table-column prop="ProductPrice" label="产品价格" align="center"></pl-table-column>
			<pl-table-column prop="TotalProductPrice" label="产品总额" align="center"></pl-table-column>
			<pl-table-column prop="AddedFee" label="增值费" align="center"></pl-table-column>
			<pl-table-column prop="UnitPriceSerCharge" label="服务费" align="center"></pl-table-column>
			<pl-table-column prop="ExchangeRate" label="汇率" align="center"></pl-table-column>
			<pl-table-column prop="Total" label="合计" align="center">
				<template slot-scope="scope">
					<span class="danger">{{scope.row.Total}}</span>
				</template>
			</pl-table-column>
			<pl-table-column prop="CustomerUserId" label="客户编码" align="center"></pl-table-column>
			<pl-table-column prop="OrderTime" label="下单时间" align="center" width="145"></pl-table-column>
			<pl-table-column prop="Remarks" label="备注" align="center" :show-overflow-tooltip='true'></pl-table-column>
			<pl-table-column prop="OrderState" label="状态" align="center">
				<template slot-scope="scope">
					<span v-if="scope.row.OrderState==1">待确认</span>
					<span v-if="scope.row.OrderState==2" class="primary">待分配</span>
					<span v-if="scope.row.OrderState==3" class="warning">已分配</span>
					<span v-if="scope.row.OrderState==4" class="success">已完成</span>
					<span v-if="scope.row.OrderState==5" class="danger">已取消</span>
				</template>
			</pl-table-column>
			<pl-table-column v-if="menuBtnShow" fixed="right" prop="OrderState" label="操作" align="center" width="178">
				<template slot-scope="scope">
					<el-button :loading="btnLoading" size="mini" type="primary" v-if="scope.row.OrderState==1"
						@click.stop="orderConfirm(scope.$index,scope.row,1)">确认</el-button>
					<el-button :loading="btnLoading" size="mini" type="danger" v-if="scope.row.OrderState==1"
						@click.stop="orderConfirm(scope.$index,scope.row,0)">取消</el-button>
					<el-button size="mini" type="warning" v-if="scope.row.OrderState!=1 && scope.row.OrderState!=5"
						@click.stop="taskModalShow(scope.$index,scope.row)">分 配 / 查 看 任务</el-button>
				</template>
			</pl-table-column>
		</pl-table>
		<!--工具条-->
		<el-col :span="24" class="toolbar">
			<el-pagination style="float: right;" @size-change="handleSizeChange" @current-change="handleCurrentChange"
				:current-page="pageIndex" :page-sizes="[10, 20, 50, 100, 1000, 10000]" :page-size="10"
				layout="total, sizes, prev, pager, next, jumper" :total="total">
			</el-pagination>
		</el-col>

		<!-- 分配任务（任务列表） -->
		<el-dialog v-dialogDrag :title="title" width="70%" :visible.sync="taskModal" :close-on-click-modal="false"
			:before-close="closeTaskModal">
			<!--工具条-->
			<el-col :span="24" class="toolbar">
				<el-button type="primary" size="mini" :disabled="disabledMore2" @click="timeModalShow(2)">分配任务
				</el-button>
			</el-col>
			<el-table border :data="tableData2" id="exportTable2" style="width: 100%"
				:header-cell-style="{background:'#fafafa'}" @selection-change="handleSelectionChange2"
				@row-click="rowClick2" ref="table2">
				<el-table-column type="selection" align="center" v-if="btnState" :selectable='disabledCheckBox'>
				</el-table-column>
				<el-table-column type="index" label="序号" align="center" width="50"></el-table-column>
				<el-table-column prop="OrderNumbers" label="任务编号" align="center" width="155px">
					<template slot-scope="scope">
						<span v-if="scope.row.AgainTaskState!=1">{{scope.row.OrderNumbers}}</span>
						<span v-if="scope.row.AgainTaskState==1">{{scope.row.OrderNumbers}}
							<div class="danger fz12">追加任务</div>
						</span>
					</template>
				</el-table-column>
				<el-table-column prop="Asin" label="产品ASIN" align="center"></el-table-column>
				<el-table-column prop="ProductName" label="产品名称" align="center" :show-overflow-tooltip='true'>
				</el-table-column>
				<el-table-column prop="ProductPrice" label="产品价格" align="center"></el-table-column>
				<el-table-column prop="OrderRemarks" label="备注" align="center" :show-overflow-tooltip='true'>
				</el-table-column>
				<el-table-column prop="TaskState" label="任务状态" align="center">
					<template slot-scope="scope">
						<span v-if="scope.row.TaskState==1">待分配</span>
						<span v-if="scope.row.TaskState==2" class="danger">待购买</span>
						<span v-if="scope.row.TaskState==3" class="primary">待确认出单</span>
						<span v-if="scope.row.TaskState==4" class="warning">待评价</span>
						<span v-if="scope.row.TaskState==5" class="primary">待确认评价</span>
						<span v-if="scope.row.TaskState==6" class="success">已完成</span>
						<span v-if="scope.row.TaskState==7" class="danger">已取消</span>
						<span v-if="scope.row.TaskState==8" class="warning">异常</span>
					</template>
				</el-table-column>
				<el-table-column prop="ExecutionTime" label="任务执行时间" align="center" width="155px">
					<template slot-scope="scope">
						<span class="danger">{{scope.row.ExecutionTime}}</span>
					</template>
				</el-table-column>
				<el-table-column prop="Name" label="操作员" align="center">
					<template slot-scope="scope">
						<span class="danger">{{scope.row.Name}}</span>
					</template>
				</el-table-column>
				<el-table-column prop="Name1" label="外派员" align="center">
					<template slot-scope="scope">
						<span class="danger">{{scope.row.Name1}}</span>
					</template>
				</el-table-column>
			</el-table>
			<!--工具条-->
			<el-col :span="24" class="toolbar">
				<el-pagination style="float: right;" @size-change="handleSizeChange2"
					@current-change="handleCurrentChange2" :current-page="pageIndex2" :page-sizes="[10, 20, 50, 100]"
					:page-size="pageSize2" layout="total, sizes, prev, pager, next, jumper" :total="total2">
				</el-pagination>
			</el-col>
			<div slot="footer" class="dialog-footer">
				<el-button @click="closeTaskModal">关 闭</el-button>
			</div>
		</el-dialog>

		<!-- 分配任务（任务执行时间） -->
		<el-dialog v-dialogDrag center title="任务执行时间" width="20%" :visible.sync="timeModal"
			:close-on-click-modal="false" :before-close="closeTimeModal" style="margin-top: -10%;">
			<div class="textCen">
				<el-date-picker v-model="taskTime" type="datetime" :picker-options="pickerOptions"
					value-format="yyyy-MM-dd HH:mm:ss" placeholder="请选择任务执行时间" style="width: 320px;"></el-date-picker>
			</div>
			<div slot="footer" class="dialog-footer">
				<el-button @click="closeTimeModal">关 闭</el-button>
				<el-button type="primary" @click="userModalShow">确 定</el-button>
			</div>
		</el-dialog>

		<!-- 分配任务（人员列表） -->
		<el-dialog v-dialogDrag title="操作员列表" :visible.sync="userModal" :close-on-click-modal="false" width="30%">
			<el-table border :data="tableData3" id="exportTable3" style="width: 100%"
				:header-cell-style="{background:'#fafafa'}" @row-click="rowClick3" ref="table3">
				<el-table-column type="index" label="序号" align="center" width="50"></el-table-column>
				<el-table-column prop="Name" label="姓名" align="center"></el-table-column>
				<el-table-column prop="LoginName" label="账号" align="center"></el-table-column>
			</el-table>
			<div slot="footer" class="dialog-footer">
				<el-button @click="userModal=false">关 闭</el-button>
			</div>
		</el-dialog>

		<!--服务费和汇率修改-->
		<el-dialog v-dialogDrag :title="titleFee" width="30%" :visible.sync="editModal" :close-on-click-modal="false"
			:before-close="closeModal">
			<el-form :model="editForm" ref="editForm" :rules='Rules' label-width='100px' status-icon>
				<el-form-item label="服务费" prop="fee">
					<el-input v-model="editForm.fee"></el-input>
				</el-form-item>
				<el-form-item label="汇率" prop="rate">
					<el-input :disabled="editForm.type==2" v-model="editForm.rate"></el-input>
				</el-form-item>
			</el-form>
			<div slot="footer" class="dialog-footer">
				<el-button @click="closeModal">取消</el-button>
				<el-button type="primary" @click="editSubmit">确定</el-button>
			</div>
		</el-dialog>

		<!-- 订单查看 -->
		<el-dialog v-dialogDrag width="70%" :title="title" :visible.sync="viewModal" :close-on-click-modal="false">
			<el-form :model='view' ref='view' label-width='150px'>
				<el-row>
					<el-col :span="24">
						<el-form-item label='产品图：'>
							<el-image style="width: 80px" class="pointer" v-if="view.ProductPictures"
								:src="view.ProductPictures" :preview-src-list="(view.ProductPictures || '').split(',')">
							</el-image>
						</el-form-item>
					</el-col>
					<el-col :span="24">
						<el-form-item label='产品链接：'>
							<el-link :href="view.ProductLink" target="_blank" type="primary" :underline="false">
								{{view.ProductLink}}
							</el-link>
						</el-form-item>
					</el-col>
				</el-row>
				<el-row>
					<el-col :span="12">
						<el-form-item label='订单编号：'>
							<span>{{view.OrderNumber}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='订单状态：'>
							<span v-if="view.OrderState==1">待确认</span>
							<span v-if="view.OrderState==2" class="warning">待分配</span>
							<span v-if="view.OrderState==3" class="primary">已分配</span>
							<span v-if="view.OrderState==4" class="success">已完成</span>
							<span v-if="view.OrderState==5" class="danger">已取消</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='国家：'>
							<span>{{view.CountryName}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='订单类型：'>
							<span v-if="view.ServiceType==1">评后返（代返）</span>
							<span v-if="view.ServiceType==2">评后返（自返）</span>
						</el-form-item>
					</el-col>
					<el-col :span="24">
						<el-form-item label='产品名称：'>
							<span>{{view.ProductName}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='产品评分：'>
							<span>{{view.ProductScore}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='店铺名：'>
							<span>{{view.ShopName}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='产品ASIN：'>
							<span>{{view.ASIN}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='产品单价：'>
							<span>{{view.ProductPrice}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='关键词类型：'>
							<span v-if="view.KeyWordType==1">产品关键词</span>
							<span v-if="view.KeyWordType==2">CPC关键词</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='关键词：'>
							<span>{{view.ProductKeyWord}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='留评率：'>
							<span>{{view.ProductPosition}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='任务开始时间：'>
							<span>{{view.StartTime}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='任务结束时间：'>
							<span>{{view.EndTime}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='任务数量：'>
							<span>{{view.Number}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='汇率：'>
							<span>{{view.ExchangeRate}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='产品总价：'>
							<span>{{view.TotalProductPrice}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='增值费：'>
							<span>{{view.AddedFee}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='服务费：'>
							<span>{{view.UnitPriceSerCharge}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='合计：'>
							<span>{{view.Total}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='订单时间：'>
							<span>{{view.OrderTime}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="12">
						<el-form-item label='客户编码：'>
							<span>{{view.CustomerUserId}}</span>
						</el-form-item>
					</el-col>
					<el-col :span="24">
						<el-form-item label='订单备注：'>
							<span>{{view.Remarks}}</span>
						</el-form-item>
					</el-col>
				</el-row>
			</el-form>
			<div slot="footer" class="dialog-footer">
				<el-button @click="viewModal=false">关 闭</el-button>
			</div>
		</el-dialog>
		<!--查看产品图大图-->
		<el-dialog v-dialogDrag :title='title2' :visible.sync='imageModal' :close-on-click-modal='false'
			:before-close="closeImageModal">
			<div class="txtCenter">
				<el-image :src='orderProductImgUrl' style="max-width: 90%;"></el-image>
			</div>
			<div slot="footer" class="dialog-footer">
				<el-button @click="closeImageModal">关 闭</el-button>
			</div>
		</el-dialog>
	</section>
</template>

<script>
	import table2excel from 'js-table2excel'

	import {
		orderList,
		orderStateNum,
		orderState,
		orderStateMore,
		orderTask,
		userList,
		orderTaskBind,
		orderTaskBindForOrder,
		orderFeeEdit,
		countryList
	} from '@/api/api';
	export default {
		name: 'order',
		data() {
			return {
				title: '',
				pageIndex: 1,
				pageSize: 10,
				total: 0,
				disabled: true, //单项禁用
				disabledMore: true, //多项禁用
				disabledEditFee: true, //修改费率禁用
				listLoading: false,
				btnLoading: false,
				tableData: [],
				checkBoxData: [], //选中数据
				searchForm: {
					searchWords: '',
					state: 0,
					country: '0',
					type: '0',
					types: '0',
					time: [],
					serveType: '0'
				},
				all: 0, //全部
				dqr: 0, //待确认
				dfp: 0, //待分配
				yfp: 0, //已分配
				ywc: 0, //已完成
				yqx: 0, //已取消
				taskModal: false,
				tableData2: [],
				checkBoxData2: [], //选中数据
				disabled2: true, //单项禁用
				disabledMore2: true, //多项禁用
				orderId: '',
				pageIndex2: 1,
				pageSize2: 10,
				total2: 0,
				timeModal: false,
				taskTime: '',
				//设置日期控件只可选择今天及以后的时间
				pickerOptions: {
					disabledDate(time) {
						return time.getTime() < Date.now() - 8.64e7;
					}
				},
				userModal: false,
				tableData3: [],
				btnState: true,
				rateData: [], //汇率数据
				editModal: false,
				titleFee: '',
				editForm: {
					fee: '',
					rate: '',
					type: 1 //订单类型(1:评后返（代返），2:评后返（自返）)
				},
				viewModal: false,
				view: {},
				imageModal: false,
				orderProductImgUrl: '',
				title2: '', //产品图大图弹窗标题
				Rules: {
					fee: [{
							required: true,
							message: '请输入服务费',
							trigger: 'blur'
						},
						{
							pattern: /^[0-9]+([.]{1}[0-9]+){0,1}$/,
							message: '服务费格式不正确',
							trigger: ['blur']
						}
					],
					rate: [{
							required: true,
							message: '请输入汇率',
							trigger: 'blur'
						},
						{
							pattern: /^[0-9]+([.]{1}[0-9]+){0,1}$/,
							message: '汇率格式不正确',
							trigger: ['blur']
						}
					]
				},
				countryData: [], //国家数据
				menuBtnShow: false,
				FPtype: '' //任务分配类型  1从整个订单列表分配 2从订单列表中的任务列表分配
			}
		},
		created() {
			this.getAllData()
			this.getOrderStateNum()
			this.getCountryData()
		},
		methods: {
			//获取国家数据
			getCountryData() {
				let _this = this
				let params = {
					country: '',
					pageIndex: 1,
					pageSize: 100000000
				}
				countryList(params).then(res => {
					_this.countryData = res.result.Entity
				}).catch((e) => {})
			},

			//获取数据
			getAllData() {
				let _this = this
				_this.listLoading = true

				// 根据角色判断订单列表按钮显示与隐藏
				let show = ''
				let roleId = sessionStorage.getItem('roleId').trim()
				let x = roleId.indexOf(1) //总管理员
				let y = roleId.indexOf(2) //子管理员
				let c = roleId.indexOf(3) //财务
				let z = roleId.indexOf(4) //操作员
				let w = roleId.indexOf(5) //外派员
				let s = roleId.indexOf(6) //业务员
				if (x >= 0 || y >= 0) {
					_this.menuBtnShow = true
				} else if (z >= 0) {
					_this.menuBtnShow = false
				} else {
					_this.menuBtnShow = false
				}
				let time = _this.searchForm.time
				let time1 = ''
				let time2 = ''
				if (time != '' && time != null) {
					time1 = time[0]
					time2 = time[1]
				}
				let params = {
					keyWord: _this.searchForm.searchWords,
					state: _this.searchForm.state,
					countryId: _this.searchForm.country,
					type: _this.searchForm.type,
					Diff: _this.searchForm.types,
					startTime: time1,
					endTime: time2,
					ServerType: _this.searchForm.serveType,
					pageIndex: _this.pageIndex,
					pageSize: _this.pageSize
				}
				orderList(params).then(res => {
					_this.listLoading = false
					_this.tableData = res.Entity
					_this.total = Number(res.TotalCount)
				}).catch((e) => {})
			},

			//获取不同状态的订单数量
			getOrderStateNum() {
				let _this = this
				let time = _this.searchForm.time
				let time1 = ''
				let time2 = ''
				if (time != '' && time != null) {
					time1 = time[0]
					time2 = time[1]
				}
				let params = {
					keyWord: _this.searchForm.searchWords,
					countryId: _this.searchForm.country,
					type: _this.searchForm.type,
					Diff: _this.searchForm.types,
					startTime: time1,
					endTime: time2,
					ServerType: _this.searchForm.serveType
				}
				orderStateNum(params).then(res => {
					_this.all = Number(res.TotalCount) //全部
					_this.dqr = Number(res.OrderStateInOne) //待确认
					_this.dfp = Number(res.OrderStateInTwo) //待分配
					_this.yfp = Number(res.OrderStateInThree) //已分配
					_this.ywc = Number(res.OrderStateInFour) //已完成
					_this.yqx = Number(res.OrderStateInFive) //已取消
				}).catch((e) => {})
			},

			//查询
			searchData() {
				let _this = this
				_this.pageIndex = 1 //页码归1
				_this.getAllData()
				_this.getOrderStateNum()
			},

			//查询某订单状态下的数据
			searchStateData(val) {
				let _this = this
				_this.pageIndex = 1 //页码归1
				_this.searchForm.state = val
				_this.getAllData()
			},

			//订单确认/取消
			orderConfirm(index, row, val) {
				let _this = this
				_this.btnLoading = true
				let params = {
					Id: row.Id,
					State: val
				}
				orderState(params).then((res) => {
					_this.btnLoading = false
					_this.getAllData()
					_this.getOrderStateNum()
				}).catch(() => {})
			},


			//批量确认与批量取消
			orderConfirmMore(val) {
				let _this = this
				let txt = ''
				if (val == 1) {
					txt = '批量确认'
				}
				if (val == 2) {
					txt = '批量取消'
				}
				let ids = _this.checkBoxData.map(item => item.Id) //选中的数据
				let num = _this.checkBoxData.length //选中的数量
				_this.$confirm('确定 ' + txt + ' 选中的【' + num + '】条订单吗？', '信息提示', {
					type: 'warning'
				}).then(() => {
					_this.btnLoading = true
					let params = {
						Id: ids,
						Type: val
					}
					orderStateMore(params).then((res) => {
						_this.btnLoading = false
						_this.getAllData()
						_this.getOrderStateNum()
					}).catch(() => {})
				}).catch(() => {})
			},

			//选中行
			rowClick(row) {
				let _this = this
				let findResult = _this.checkBoxData.findIndex((value, index) => {
					return value == row
				})
				if (findResult != -1) {
					_this.$refs.table.toggleRowSelection([{
						row: row,
						selected: false
					}])
				} else {
					_this.$refs.table.toggleRowSelection([{
						row: row,
						selected: true
					}])
				}
			},

			// 是否有选中
			handleSelectionChange(val) {
				let _this = this
				_this.checkBoxData = val
				let checkNum = _this.checkBoxData.length
				if (checkNum == 1) {
					let state = val[0].OrderState
					if (state == 1) {
						_this.disabledEditFee = false
					} else {
						_this.disabledEditFee = true
					}
					_this.disabled = false
					_this.disabledMore = false
				} else if (checkNum > 1) {
					_this.disabled = true
					_this.disabledMore = false
					_this.disabledEditFee = true
				} else {
					_this.disabled = true
					_this.disabledMore = true
					_this.disabledEditFee = true
				}
			},

			// 重置
			resetSearch() {
				let _this = this
				_this.searchForm.searchWords = ''
				_this.searchForm.country = '0'
				_this.searchForm.type = '0'
				_this.searchForm.types = '0'
				_this.searchForm.time = []
				_this.searchForm.serveType = '0'
				_this.pageIndex = 1
				_this.getAllData()
				_this.getOrderStateNum()
			},

			//翻页
			handleSizeChange(val) {
				let _this = this
				_this.pageSize = val
				_this.getAllData()
			},
			handleCurrentChange(val) {
				let _this = this
				_this.pageIndex = val
				_this.getAllData()
			},

			//打开分配任务
			taskModalShow(index, row) {
				let _this = this
				_this.title = '订单【' + row.OrderNumber + '】任务列表'
				_this.orderId = row.Id
				_this.getTaskData()
			},

			//如果不是待分配状态则禁用该行复选框 
			disabledCheckBox(row, index) {
				let checked = ''
				let state = row.TaskState
				if (state == 1) {
					checked = true
				} else {
					checked = false
				}
				return checked
			},

			//获取订单任务列表
			getTaskData() {
				let _this = this
				let params = {
					Id: _this.orderId,
					pageIndex: _this.pageIndex2,
					pageSize: _this.pageSize2
				}
				orderTask(params).then(res => {
					_this.tableData2 = res.Entity
					_this.total2 = Number(res.TotalCount)
					_this.taskModal = true //获取数据后显示模态框
				}).catch((e) => {})
			},

			//任务信息弹窗关闭
			closeTaskModal() {
				let _this = this
				_this.taskModal = false
				_this.tableData2 = []
				_this.checkBoxData2 = []
				_this.pageIndex2 = 1
				_this.pageSize2 = 10
			},

			//任务信息选中行
			rowClick2(row) {
				let _this = this
				//判断如果该行数据不是待分配状态则不再触发点击行选中事件
				let checked = ''
				let state = row.TaskState
				if (state == 1) {
					let findResult = _this.checkBoxData2.findIndex((value, index) => {
						return value == row
					})
					if (findResult != -1) {
						_this.$refs.table2.toggleRowSelection(row, false);
					} else {
						_this.$refs.table2.toggleRowSelection(row, true);
					}
				}
			},

			// 任务信息是否有选中
			handleSelectionChange2(val) {
				let _this = this
				_this.checkBoxData2 = val
				let checkNum = _this.checkBoxData2.length
				if (checkNum == 1) {
					_this.disabled2 = false
					_this.disabledMore2 = false
				} else if (checkNum > 1) {
					_this.disabled2 = true
					_this.disabledMore2 = false
				} else {
					_this.disabled2 = true
					_this.disabledMore2 = true
				}
			},

			//任务信息翻页
			handleSizeChange2(val) {
				let _this = this
				_this.pageSize2 = val
				_this.getTaskData()
			},
			handleCurrentChange2(val) {
				let _this = this
				_this.pageIndex2 = val
				_this.getTaskData()
			},

			//任务执行时间弹窗
			timeModalShow(val) {
				let _this = this
				_this.timeModal = true
				_this.FPtype = val //任务分配类型
			},

			//关闭任务执行时间弹窗
			closeTimeModal() {
				let _this = this
				_this.timeModal = false
				_this.taskTime = ''
				_this.FPtype = ''
			},

			//打开分配人员弹窗
			userModalShow() {
				let _this = this
				_this.getUserData()
			},

			//获取操作员列表
			getUserData() {
				let _this = this
				let params = {
					name: '',
					pageIndex: 1,
					pageSize: 100000000,
				}
				userList(params).then(res => {
					let data = res.Entity
					let arr = []
					for (let x in data) {
						let roleId = data[x].RoolId ? data[x].RoolId : ''
						let state = data[x].State
						//如果角色包含4(操作员)并且状态为有效
						if ((roleId.indexOf(4) >= 0 || roleId.indexOf(7) >= 0) && state == 1) {
							arr.push(data[x])
						}
					}
					_this.tableData3 = arr
					_this.userModal = true //获取数据后显示模态框 
				}).catch((e) => {})
			},

			//人员选中行绑定人员
			rowClick3(val) {
				let _this = this
				_this.$refs.table3.clearSelection()
				_this.$refs.table3.toggleRowSelection(val, true)

				//判断是从订单分配任务还是从任务分配任务
				if (_this.FPtype == '1') {
					let orderIds = _this.checkBoxData.map(item => item.Id) //订单表选中的数据
					let userId = val.Id //人员表选中的数据
					let orderNum = _this.checkBoxData.length //选中的任务数
					_this.$confirm('确认要将选中的 ' + orderNum + ' 条订单分配给【' + val.Name + '】吗？', '信息提示', {
						type: 'warning'
					}).then(() => {
						let params = {
							Id: orderIds,
							BackUserId: userId,
							ExecutionTime: _this.taskTime
						}
						orderTaskBindForOrder(params).then((res) => {
							_this.userModal = false
							_this.closeTimeModal()
							_this.getAllData()
							_this.getOrderStateNum()
						}).catch(() => {})
					}).catch(() => {})
				}
				if (_this.FPtype == '2') {
					let taskIds = _this.checkBoxData2.map(item => item.Id) //任务表选中的数据
					let userId = val.Id //人员表选中的数据
					let taskNum = _this.checkBoxData2.length //选中的任务数
					_this.$confirm('确认要将选中的 ' + taskNum + ' 条任务分配给【' + val.Name + '】吗？', '信息提示', {
						type: 'warning'
					}).then(() => {
						let params = {
							id: taskIds,
							userId: userId,
							stateTime: _this.taskTime,
							orderId: _this.orderId
						}
						orderTaskBind(params).then((res) => {
							_this.userModal = false
							_this.closeTimeModal()
							_this.getTaskData()
							_this.getAllData()
							_this.getOrderStateNum()
						}).catch(() => {})
					}).catch(() => {})
				}
			},

			//打开修改服务费和汇率弹窗
			editModalShow() {
				let _this = this
				let orderNum = _this.checkBoxData[0].OrderNumber
				_this.editForm.fee = _this.checkBoxData[0].UnitPriceSerCharge
				_this.editForm.rate = _this.checkBoxData[0].ExchangeRate
				_this.editForm.type = _this.checkBoxData[0].ServiceType
				_this.titleFee = '订单【' + orderNum + '】费率修改'
				_this.editModal = true
			},

			// 修改服务费和汇率
			editSubmit() {
				let _this = this
				_this.$refs.editForm.validate((valid) => {
					if (valid) {
						let params = {
							Id: _this.checkBoxData[0].Id,
							servicecharge: _this.editForm.fee,
							exchangerate: _this.editForm.rate
						}
						orderFeeEdit(params).then(res => {
							_this.closeModal()
							_this.getAllData()
						}).catch((e) => {})
					}
				})
			},

			//关闭服务费汇率修改弹窗
			closeModal() {
				let _this = this
				_this.editModal = false
				_this.$refs['editForm'].resetFields()
				_this.editForm = {
					fee: '',
					rate: ''
				}
			},

			//订单详情
			viewModalShow(index, row) {
				let _this = this
				_this.title = '订单【' + row.OrderNumber + '】详情'
				_this.view = Object.assign({}, row)
				_this.view.ProductPictures = this.$IMG_URL + row.ProductPictures
				_this.viewModal = true //获取到数据后显示模态框
			},

			//查看产品图大图（列表点击图片查看）
			showImage(index, row) {
				let _this = this
				_this.imageModal = true
				_this.title2 = '订单【' + row.OrderNumber + '】产品图'
				_this.orderProductImgUrl = this.$IMG_URL + row.ProductPictures
			},

			closeImageModal() {
				let _this = this
				_this.imageModal = false
				_this.orderProductImgUrl = ''
			},

			//复制订单编号
			copy(index, row) {
				let oInput = document.createElement('input');
				oInput.value = row.OrderNumber;
				document.body.appendChild(oInput);
				oInput.select(); // 选择对象;
				document.execCommand("Copy"); // 执行浏览器复制命令
				this.$message({
					message: '订单编号复制成功',
					type: 'success'
				});
				oInput.remove()
			},

			//查询条件去空格
			searchToTrim() {
				let _this = this
				_this.searchForm.searchWords = _this.searchForm.searchWords.trim()
			},

			//导出
			exportExcel() {
				const column = [{
						title: '订单编号',
						key: 'OrderNumber',
						type: 'text'
					},
					{
						title: '产品图',
						key: 'ExpProductImg',
						type: 'image',
						width: 100,
						height: 100
					},
					{
						title: '订单类型',
						key: 'ExpServiceType',
						type: 'text'
					},
					{
						title: '国家',
						key: 'CountryName',
						type: 'text'
					},
					{
						title: '国家ID',
						key: 'CountryId',
						type: 'text'
					},
					{
						title: 'ASIN',
						key: 'ASIN',
						type: 'text'
					},
					{
						title: '产品名称',
						key: 'ProductName',
						type: 'text'
					},
					{
						title: '店铺',
						key: 'ShopName',
						type: 'text'
					},
					{
						title: '关键词',
						key: 'ProductKeyWord',
						type: 'text'
					},
					{
						title: '品牌',
						key: 'Brand',
						type: 'text'
					},
					{
						title: '产品位置',
						key: 'Place',
						type: 'text'
					},
					{
						title: '任务数',
						key: 'Number',
						type: 'text'
					},
					{
						title: '待购买数',
						key: 'noBuy',
						type: 'text'
					},
					{
						title: '产品价格',
						key: 'ProductPrice',
						type: 'text'
					},
					{
						title: '产品总额',
						key: 'TotalProductPrice',
						type: 'text'
					},
					{
						title: '增值费',
						key: 'AddedFee',
						type: 'text'
					},
					{
						title: '服务费',
						key: 'UnitPriceSerCharge',
						type: 'text'
					},
					{
						title: '汇率',
						key: 'ExchangeRate',
						type: 'text'
					},
					{
						title: '合计',
						key: 'Total',
						type: 'text'
					},
					{
						title: '客户编码',
						key: 'CustomerUserId',
						type: 'text'
					},
					{
						title: '下单时间',
						key: 'OrderTime',
						type: 'text'
					},
					{
						title: '备注',
						key: 'Remarks',
						type: 'text'
					},
					{
						title: '状态',
						key: 'ExpOrderState',
						type: 'text'
					},
				]

				// 1.title为列名
				// 2.key为data数据每个对象对应的key
				// 3.若为图片格式, 需要加type为image的说明,并且可以设置图片的宽高
				const data = this.tableData
				// data数据一些特殊处理
				for (const t in data) {
					data[t].ExpProductImg = this.$IMG_URL + data[t].ProductPictures

					let TxtServiceType = ''
					if (data[t].ServiceType == 1) {
						TxtServiceType = '评后返（代返）'
					}
					if (data[t].ServiceType == 2) {
						TxtServiceType = '评后返（自返）'
					}
					data[t].ExpServiceType = TxtServiceType

					let TxtOrderState = ''
					if (data[t].OrderState == 1) {
						TxtOrderState = '待确认'
					}
					if (data[t].OrderState == 2) {
						TxtOrderState = '待分配'
					}
					if (data[t].OrderState == 3) {
						TxtOrderState = '已分配'
					}
					if (data[t].OrderState == 4) {
						TxtOrderState = '已完成'
					}
					if (data[t].OrderState == 5) {
						TxtOrderState = '已取消'
					}
					data[t].ExpOrderState = TxtOrderState
				}
				let date = new Date()
				let year = date.getFullYear()
				let month = date.getMonth() < 9 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1
				let day = date.getDate() <= 9 ? "0" + date.getDate() : date.getDate()
				let time = year + '-' + month + '-' + day

				const excelName = '订单数据' + '_' + time + '.xls'
				table2excel(column, data, excelName)
			}
		}
	}
</script>
